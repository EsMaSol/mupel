#!/bin/bash
###############################################################################
#                                                                             #
#     Copyright (C) 2015 Team KODI (Alwin Esch)                               #
#     http://kodi.tv                                                          #
#                                                                             #
#  This program is free software: you can redistribute it and/or modify       #
#  it under the terms of the GNU General Public License as published by       #
#  the Free Software Foundation, either version 3 of the License, or          #
#  (at your option) any later version.                                        #
#                                                                             #
#  This program is distributed in the hope that it will be useful,            #
#  but WITHOUT ANY WARRANTY; without even the implied warranty of             #
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the              #
#  GNU General Public License for more details.                               #
#                                                                             #
#  You should have received a copy of the GNU General Public License          #
#  along with this program.  If not, see <http://www.gnu.org/licenses/>.      #
#                                                                             #
###############################################################################

DIST=`grep DISTRIB_ID /etc/*-release | awk -F '=' '{print $2}'`
BASE_PATH=$(cd $(dirname $0) ; pwd -P)
PATH="$BASE_PATH/tools:$PATH"

. $BASE_PATH/tools/tool_functions

##
# Default configurations
MUPEL_VERSION=
INSTALL_PREFIX=$HOME/.mupel

USE_LINUX_X86_32="FALSE"
USE_LINUX_X86_64="FALSE"
USE_LINUX_RPBI="FALSE"
USE_MS_WINDOWS_32="FALSE"
USE_MS_WINDOWS_64="FALSE"
USE_MAC_OS_X_32="FALSE"
USE_MAC_OS_X_64="FALSE"
USE_ANDROID_ARM="FALSE"
USE_ANDROID_X86="FALSE"
USE_IOS_ATV2="FALSE"

RELEASE_BUILD=0
DEBUG_BUILD=0

KODI_SOURCE_URL=""
KODI_SOURCE_URL_INACTIVE=""
KODI_SOURCE_URL_BASE="https://github.com/xbmc/xbmc"
KODI_SOURCE_BRANCH=""
KODI_SOURCE_USE_BASE="FALSE"
KODI_RUN_TESTS="FALSE"
KODI_CONF_IN_DIRECT_BUILD="FALSE"
KODI_DEP_CLEAN="FALSE"
KODI_SEL_ADDON=""
CEF_SOURCE_URL=""
CEF_SOURCE_URL_INACTIVE=""
CEF_SOURCE_URL_BASE="https://github.com/kodi-web/cef"
CEF_SOURCE_BRANCH=""
CEF_SOURCE_USE_BASE="FALSE"
CEF_VERBOSE_BUILD="FALSE"
DEPOT_TOOLS_URL=""

INCLUDE_KODI="TRUE"
INCLUDE_KODI_ADDONS="FALSE"
INCLUDE_CEF="FALSE"
INCLUDE_USER_SCRIPT="FALSE"

ANDROID_SEL_AVD_ARM=
ANDROID_SEL_AVD_x86=

SUPPORT_CEF="FALSE"

CPU_PROC_JOBS=8

ADD_PATHS=""
DO_CLEAN=0 #<TODO
WAIT_TIMEOUT=30;
OS_START_TIMEOUT=90;

##
# Set defaults
[ ! -d "$BASE_PATH/build" ] && mkdir "$BASE_PATH/build"
if [ ! -f "$HOME/.mupel/mupel.conf" ];then
{
  bash mupel-install
  ret=$?
  if [[ $ret != 0 ]];then
  {
    exit $ret
  } fi
} fi

. "$HOME/.mupel/mupel.conf";

if [ ! -f "$BASE_PATH/versions" ];then
{
  showWarningDialog "\
The needed CEF binary version file for Kodi is not present and normally included in Mupel package!
Please fix, for the moment becomes 'undefined' used as version.

It must be on file in '$BASE_PATH/versions'!
"
  CEF_KODI_BINARY_VERSION="undefined"
}
else
  . "$BASE_PATH/versions";fi

PATH="$ADD_PATHS:$PATH";

# General control is's
GEN__BTN______START_BUILD_ALL=0
GEN__BTN_______STOP_BUILD_ALL=1
GEN__BTN____CREATE_INST_MUPEL=2
GEN__BTN______________DUMMY_1=3
GEN__BTN______DOWNLOAD_UPDATE=4
GEN__BTN____CREATE_NEW_BRANCH=5
GEN__BTN______PREPARE_PATCHES=6
GEN__BTN____DEL_OLD_LOG_FILES=7
GEN__BTN____________CLEAR_LOG=8
GEN_____________________SEP__=9
GEN__CHK_________INCLUDE_KODI=10
GEN__CHK__INCLUDE_KODI_ADDONS=11
GEN__CHK__________INCLUDE_CEF=12
GEN__BTN______________DUMMY_2=13
GEN__TERMPROC_______BUILD_LOG=14

# Build control id's
BUILD__BTN_____BUILD_COMPLETE=0
BUILD__BTN__BUILD_KODI_DIRECT=1
BUILD__BTN___BUILD_CEF_DIRECT=2
BUILD__BTN____BUILD_SEL_ADDON=3
BUILD__BTN_________STOP_BUILD=4
BUILD__BTN__________CLEAR_LOG=5
BUILD__BTN_____OPEN_LAST_LOGS=6
BUILD__BTN________LAUNCH_KODI=7
BUILD__BTN___FORCE_BUILD_STEP=8
BUILD__BTN_PERF_CODE_DEPCLEAN=9
BUILD__CB______________ADD_ON=10
BUILD__TERMPROC_____BUILD_LOG=11

# Setting control id's
SET_KODI________________SEP__=0
SET_KODI______________LABEL__=1
SET_KODI________SOURCE_REPOSI=2
SET_KODI__________SOURCE_BASE=3
SET_KODI________SOURCE_BRANCH=4
SET_KODI____________RUN_TESTS=5
SET_KODI_CONF_IN_DIRECT_BUILD=6
SET_KODI____________DEP_CLEAN=7
SET_CEF_________________SEP__=8
SET_CEF_______________LABEL__=9
SET_CEF_________SOURCE_REPOSI=10
SET_CEF___________SOURCE_BASE=11
SET_CEF_________SOURCE_BRANCH=12
SET_CEF_________VERBOSE_BUILD=13
SET_LINUX_______________SEP__=14
SET_LINUX_____________LABEL__=15
SET_LINUX__________BUILD_TYPE=16
SET_LINUX_____USED_LINUX_DIST=17
SET_LINUX_____OPEN_DIST_CONTR=18
SET_WINDOWS_____________SEP__=19
SET_WINDOWS___________LABEL__=20
SET_WINDOWS________BUILD_TYPE=21
SET_WINDOWS____________TARGET=22
SET_WINDOWS______SSH_USERNAME=23
SET_WINDOWS______SSH_PASSWORD=24
SET_MAC_________________SEP__=25
SET_MAC_______________LABEL__=26
SET_MAC____________BUILD_TYPE=27
SET_MAC____IOS_ATV_BUILD_TYPE=28
SET_MAC________________TARGET=29
SET_MAC__________SSH_USERNAME=30
SET_MAC__________SSH_PASSWORD=31
SET_MAC________________SSH_IP=32
SET_MAC______________SSH_PORT=33
SET_ANDROID_____________SEP__=34
SET_ANDROID___________LABEL__=35
SET_ANDROID_______AVD_MANAGER=36
SET_ANDROID________BUILD_TYPE=37
SET_ANDROID____ARM_EMU_SOURCE=38
SET_ANDROID__BUILD_SYS_TARGET=39
SET_ANDROID____x86_EMU_SOURCE=40
SET_VARIOUS_____________SEP__=41
SET_VARIOUS_____CPU_PROC_JOBS=42

###############################################################################
# Functions
{

function loadGitBranches()
{
  local load_url=$1
  local selected_branch=$2

  local git_entries=$(git ls-remote "$load_url")
  ret=$?
  if [[ $ret = 0 ]];then
  {
    git_entries=$(echo "$git_entries"| grep "refs/heads" | awk -F '/' '{print $3}')
    local targets=
    local last=""
    for i in $git_entries; do
    {
      if [ ! -z $last ];then
        targets+="!";fi
      last=$i
      if [[ $i == $selected_branch ]];then
        targets+="^";fi
      targets+="$i"
    } done
    targets+="!"

    echo "$targets"
    return 0;
  }
  else
  {
    handleErrorsCodes $ret "git" "$load_url";
    return 1;
  } fi
}

function parse_values()
{
  local field=$1
  local id=$2
  local value="$3"
  local git_entries;
  local targets;

  loadConfigFile noOutLock:

  if [ "$field" = "general" ];then
  {
    if [[ $id = $GEN__CHK_________INCLUDE_KODI ]];then # handle 'Include Kodi' change
      INCLUDE_KODI=${value%|};
    elif [[ $id = $GEN__CHK__INCLUDE_KODI_ADDONS ]];then # handle 'Include Kodi add-ons' change
      INCLUDE_KODI_ADDONS=${value%|};
    elif [[ $id = $GEN__CHK__________INCLUDE_CEF ]];then # handle 'Include CEF' change
      INCLUDE_CEF=${value%|};fi
  }
  elif [ "$field" = "add-ons" ];then
  {
    if [ -f $BASE_PATH/build/kodi-$GIT_USER/kodi/project/cmake/addons/bootstrap/repositories/binary-addons.txt ];then
    {
      if [ ! -d $BASE_PATH/build/kodi-$GIT_USER/kodi-repo-binary-addons ];then
      {
        local url=$(cat $BASE_PATH/build/kodi-$GIT_USER/kodi/project/cmake/addons/bootstrap/repositories/binary-addons.txt | awk -F ' ' '{print $2}');
        local branch=$(cat $BASE_PATH/build/kodi-$GIT_USER/kodi/project/cmake/addons/bootstrap/repositories/binary-addons.txt | awk -F ' ' '{print $3}');
        handleGITLoad $BASE_PATH/build/kodi-$GIT_USER kodi-repo-binary-addons $url $branch
      } fi
      addon_entries=$(cd $BASE_PATH/build/kodi-$GIT_USER/kodi-repo-binary-addons; ls -d */ | sed 's|[/]||g');
    }
    else
      addon_entries=$(ls -1 $BASE_PATH/build/kodi-$GIT_USER/kodi/project/cmake/addons/addons);fi
    targets=
    last=""
    for i in $addon_entries; do
    {
      if [ ! -z $last ];then
        targets+="!";fi
      last=$i
      if [[ $i == $KODI_SEL_ADDON ]];then
        targets+="^";fi
      targets+="$i"
    } done
    targets+="!"

    echo "#> msg field $BUILD__CB______________ADD_ON:set ${targets};"
  }
  elif [ "$field" = "settings" ];then
  {
    IFS_BU=$IFS
    unset IFS

    #####
    # Kodi
    if [[ $id = 1 ]] || [[ $id = $SET_KODI________SOURCE_REPOSI ]];then
    { # handle 'kodi git url' change
      echo "#> msg field $SET_KODI________SOURCE_BRANCH:enable 0;"

      local targets=$(loadGitBranches ${value%|} $KODI_SOURCE_BRANCH );
      if [ $? = 0 ];then
      {
        KODI_SOURCE_URL=${value%|};
        [[ $id != $SET_KODI________SOURCE_REPOSI ]] && echo "#> msg field $SET_KODI________SOURCE_REPOSI:set ${KODI_SOURCE_URL};";
        echo "#> msg field $SET_KODI________SOURCE_BRANCH:set ${targets};";
        echo "#> msg field $SET_KODI________SOURCE_BRANCH:enable 1;";
      } fi
      echo "#> msg field $SET_KODI________SOURCE_REPOSI:enable $([ $KODI_SOURCE_USE_BASE = "TRUE" ] && echo 0 || echo 1);";
    }
    elif [[ $id = $SET_KODI__________SOURCE_BASE ]];then
    {
      echo "#> msg field $SET_KODI________SOURCE_BRANCH:enable 0;"

      KODI_SOURCE_USE_BASE=${value%|}
      if [ $KODI_SOURCE_USE_BASE = "TRUE" ];then
      {
        KODI_SOURCE_URL_INACTIVE=$KODI_SOURCE_URL
        KODI_SOURCE_URL=$KODI_SOURCE_URL_BASE
      }
      else
      {
        KODI_SOURCE_URL=$KODI_SOURCE_URL_INACTIVE
      } fi

      local targets=$(loadGitBranches $KODI_SOURCE_URL $KODI_SOURCE_BRANCH );
      if [ $? = 0 ];then
      {
        echo "#> msg field $SET_KODI________SOURCE_REPOSI:set ${KODI_SOURCE_URL};";
        echo "#> msg field $SET_KODI________SOURCE_BRANCH:set ${targets};";
        echo "#> msg field $SET_KODI________SOURCE_BRANCH:enable 1;";
      } fi

      echo "#> msg field $SET_KODI________SOURCE_REPOSI:enable $([ $KODI_SOURCE_USE_BASE = "TRUE" ] && echo 0 || echo 1);";
    }
    elif [[ $id = $SET_KODI________SOURCE_BRANCH ]];then
    {
      # Trigger for update
      KODI_SOURCE_BRANCH=${value%|}
    }
    elif [[ $id = $SET_KODI____________RUN_TESTS ]];then
    {
      KODI_RUN_TESTS=${value%|}
    }
    elif [[ $id = $SET_KODI_CONF_IN_DIRECT_BUILD ]];then
    {
      KODI_CONF_IN_DIRECT_BUILD=${value%|}
    }
    elif [[ $id = $SET_KODI____________DEP_CLEAN ]];then
    {
      KODI_DEP_CLEAN=${value%|}
    }
    #####
    # CEF
    elif [[ $id = 8 ]] || [[ $id = $SET_CEF_________SOURCE_REPOSI ]];then
    {  # handle 'cef git url' change
      echo "#> msg field $SET_CEF_________SOURCE_BRANCH:enable 0;"

      local targets=$(loadGitBranches ${value%|} $CEF_SOURCE_BRANCH );
      if [ $? = 0 ];then
      {
        CEF_SOURCE_URL=${value%|};
        [[ $id != $SET_CEF_________SOURCE_REPOSI ]] && echo "#> msg field $SET_CEF_________SOURCE_REPOSI:set ${CEF_SOURCE_URL};";
        echo "#> msg field $SET_CEF_________SOURCE_BRANCH:set ${targets};";
        echo "#> msg field $SET_CEF_________SOURCE_BRANCH:enable 1;"
      } fi
      echo "#> msg field $SET_CEF_________SOURCE_REPOSI:enable $([ $CEF_SOURCE_USE_BASE = "TRUE" ] && echo 0 || echo 1);";
    }
    elif [[ $id = $SET_CEF___________SOURCE_BASE ]];then
    {
      echo "#> msg field $SET_CEF_________SOURCE_BRANCH:enable 0;"

      CEF_SOURCE_USE_BASE=${value%|}
      if [ $CEF_SOURCE_USE_BASE = "TRUE" ];then
      {
        CEF_SOURCE_URL_INACTIVE=$CEF_SOURCE_URL
        CEF_SOURCE_URL=$CEF_SOURCE_URL_BASE
      }
      else
      {
        CEF_SOURCE_URL=$CEF_SOURCE_URL_INACTIVE
      } fi

      local targets=$(loadGitBranches $CEF_SOURCE_URL $CEF_SOURCE_BRANCH );
      if [ $? = 0 ];then
      {
        echo "#> msg field $SET_CEF_________SOURCE_REPOSI:set ${CEF_SOURCE_URL};";
        echo "#> msg field $SET_CEF_________SOURCE_BRANCH:set ${targets};";
        echo "#> msg field $SET_CEF_________SOURCE_BRANCH:enable 1;"
      } fi

      echo "#> msg field $SET_CEF_________SOURCE_REPOSI:enable $([ $CEF_SOURCE_USE_BASE = "TRUE" ] && echo 0 || echo 1);";
    }
    elif [[ $id = $SET_CEF_________SOURCE_BRANCH ]];then
    {
      # Trigger for update
      CEF_SOURCE_BRANCH=${value%|}
    }
    elif [[ $id = $SET_CEF_________VERBOSE_BUILD ]];then
    {
      CEF_VERBOSE_BUILD=${value%|}
    }
    #####
    # Linux
    elif [[ $id = $SET_LINUX_____USED_LINUX_DIST ]];then
    {
      USE_LINUX_X86_DISTR=${value%|}
      export USE_LINUX_X86_DISTR
    }
    elif [[ $id = $SET_LINUX_____OPEN_DIST_CONTR ]];then
    {
      echo "$id unused here"
    }
    elif [[ $id = $SET_LINUX__________BUILD_TYPE ]];then
    {
      . $HOME/.mupel/windows.conf;
      LINUX_BUILD_TYPE=${value%|}
      export LINUX_BUILD_TYPE
    }
    #####
    # MS Windows
    elif [[ $id = $SET_WINDOWS____________TARGET ]];then
    {
      . $HOME/.mupel/windows.conf;
      WINDOWS_DEFAULT_RUN=${value%|}
      saveWindowsConfigFile
      export WINDOWS_DEFAULT_RUN
    }
    elif [[ $id = $SET_WINDOWS______SSH_USERNAME ]];then
    {
      . $HOME/.mupel/windows.conf;
      WINDOWS_SSH_USERNAME=${value%|}
      saveWindowsConfigFile
      export WINDOWS_SSH_USERNAME
    }
    elif [[ $id = $SET_WINDOWS______SSH_PASSWORD ]];then
    {
      . $HOME/.mupel/windows.conf;
      WINDOWS_SSH_PASSWORD=${value%|}
      saveWindowsConfigFile
      export WINDOWS_SSH_PASSWORD
    }
    elif [[ $id = $SET_WINDOWS________BUILD_TYPE ]];then
    {
      . $HOME/.mupel/windows.conf;
      WINDOWS_BUILD_TYPE=${value%|}
      saveWindowsConfigFile
      export WINDOWS_BUILD_TYPE
    }
    #####
    # Max OS-X
    elif [[ $id = $SET_MAC________________TARGET ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_DEFAULT_RUN=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_DEFAULT_RUN
    }
    elif [[ $id = $SET_MAC__________SSH_USERNAME ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_SSH_USERNAME=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_SSH_USERNAME
    }
    elif [[ $id = $SET_MAC__________SSH_PASSWORD ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_SSH_PASSWORD=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_SSH_PASSWORD
    }
    elif [[ $id = $SET_MAC________________SSH_IP ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_SSH_IP=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_SSH_IP
    }
    elif [[ $id = $SET_MAC______________SSH_PORT ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_SSH_PORT=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_SSH_PORT
    }
    elif [[ $id = $SET_MAC____________BUILD_TYPE ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      MAC_OS_X_BUILD_TYPE=${value%|}
      saveMacOSXConfigFile
      export MAC_OS_X_BUILD_TYPE
    }
    elif [[ $id = $SET_MAC____IOS_ATV_BUILD_TYPE ]];then
    {
      . $HOME/.mupel/mac-osx.conf;
      IOS_ATV2_BUILD_TYPE=$(echo ${value%|} | tr '[:upper:]' '[:lower:]');
      saveMacOSXConfigFile
      export IOS_ATV2_BUILD_TYPE
    }
    #####
    # Android
    elif [[ $id = $SET_ANDROID________BUILD_TYPE ]];then
    {
      . $HOME/.mupel/android.conf;
      ANDROID_BUILD_TYPE=${value%|}
      saveAndroidConfigFile
      export ANDROID_BUILD_TYPE
    }
    elif [[ $id = $SET_ANDROID____ARM_EMU_SOURCE ]];then
    {
      . $HOME/.mupel/android.conf;
      ANDROID_SEL_AVD_ARM=$(echo ${value%|} | awk -F 'Name: ' '{print $2}' | awk -F ' - ' '{print $1}');
      saveAndroidConfigFile
    }
    elif [[ $id = $SET_ANDROID__BUILD_SYS_TARGET ]];then
    {
      . $HOME/.mupel/android.conf;
      ANDROID_SEL_TARGET=${value%|}
      saveAndroidConfigFile

      echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:set $(getAndroidAVDS arm);"
      echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:set $(getAndroidAVDS x86);"
    }
    elif [[ $id = $SET_ANDROID____ARM_EMU_SOURCE ]];then
    {
      . $HOME/.mupel/android.conf;
      ANDROID_SEL_AVD_X86=$(echo ${value%|} | awk -F 'Name: ' '{print $2}' | awk -F ' - ' '{print $1}');
      saveAndroidConfigFile
    }
    #####
    # General
    elif [[ $id = $SET_VARIOUS_____CPU_PROC_JOBS ]];then
    {
      value=${value%|}
      [ -z $value ] && value=8;
      CPU_PROC_JOBS=${value%,000000}
    } fi
    set IFS=$IFS_BU
  } fi

  saveConfigFile noInLock;
}

function buildThreadBaseGeneralProcess()
{
  local stand_alone=$1

  if [ -f "$BASE_PATH/build/creation-general.log" ];then
    mv "$BASE_PATH/build/creation-general.log" "$BASE_PATH/build/creation-general-`date +%F_%H-%m`.old.log";fi
  touch "$BASE_PATH/build/creation-general.log"

  bash "$BASE_PATH/tools/basic-system-creation.build" --temp-dir "$TEMP_DIR" >> "/dev/stdout" 2>&1 | \
  tee "$BASE_PATH/build/creation-general.log"

  local error_value=${?}
  if [ -f $TEMP_DIR/creation-general.failed ];then
  {
    rm -f $TEMP_DIR/creation-general.failed
    showdialog --title="Warning" \
               --image="$BASE_PATH/icons/icon-warning-128x128.png" \
               --image-on-top --form \
               --text="\
Basic system creation failed!
Systems build stopped here." \
               --button=gtk-ok:1 2> /dev/null &
    rm -f "$TEMP_DIR/build_thread-base_general.pid";
    exit ${error_value}
  } fi
}

function buildThreadBaseGeneral()
{
  (
    loadConfigFile
    sleep 1
    buildThreadBaseGeneralProcess 1
    sleep 1

    [[ $USE_LINUX_X86_32 = "TRUE" ]]  ||
    [[ $USE_LINUX_X86_64 = "TRUE" ]]  && echo "#< msg start_build;" >> "$thread3_in"
    [[ $USE_LINUX_RPBI = "TRUE" ]]    && echo "#< msg start_build;" >> "$thread4_in"
    [[ $USE_MS_WINDOWS_32 = "TRUE" ]] ||
    [[ $USE_MS_WINDOWS_64 = "TRUE" ]] && echo "#< msg start_build;" >> "$thread5_in"
    [[ $USE_MAC_OS_X_32 = "TRUE" ]]   ||
    [[ $USE_MAC_OS_X_64 = "TRUE" ]]   && echo "#< msg start_build;" >> "$thread6_in"
    [[ $USE_ANDROID_ARM = "TRUE" ]]   ||
    [[ $USE_ANDROID_X86 = "TRUE" ]]   && echo "#< msg start_build;" >> "$thread7_in"
    [[ $USE_IOS_ATV2 = "TRUE" ]]      && echo "#< msg start_build;" >> "$thread8_in"

    sleep 3

    while :;do
    {
      STILL_ACTIVE=0;
      if [[ $USE_LINUX_X86_32 = "TRUE" ]]    && [ -f "$TEMP_DIR/build_thread-linux-x86_32.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_LINUX_X86_64 = "TRUE" ]]  && [ -f "$TEMP_DIR/build_thread-linux-x86_64.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_LINUX_RPBI = "TRUE" ]]    && [ -f "$TEMP_DIR/build_thread-linux-rpbi.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_MS_WINDOWS_32 = "TRUE" ]] && [ -f "$TEMP_DIR/build_thread-win-x86_32.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_MS_WINDOWS_64 = "TRUE" ]] && [ -f "$TEMP_DIR/build_thread-win-x86_64.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_MAC_OS_X_32 = "TRUE" ]]   && [ -f "$TEMP_DIR/build_thread-osx-x86_32.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_MAC_OS_X_64 = "TRUE" ]]   && [ -f "$TEMP_DIR/build_thread-osx-x86_64.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_ANDROID_ARM = "TRUE" ]]   && [ -f "$TEMP_DIR/build_thread-android-arm.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_ANDROID_X86 = "TRUE" ]]   && [ -f "$TEMP_DIR/build_thread-android-x86.pid" ];then
        STILL_ACTIVE=1
      elif [[ $USE_IOS_ATV2 = "TRUE" ]]      && [ -f "$TEMP_DIR/build_thread-ios_atv2.pid" ];then
        STILL_ACTIVE=1;fi

      if [[ $STILL_ACTIVE = 0 ]];then
      {
        printf "${BRIGHT}${GREEN}Complete build of all available systems done${NORMAL}\n";

        rm -f "$TEMP_DIR/build_thread-base_general.pid";
        exit 0;
      } fi

      sleep 2
    } done
    rm -f "$TEMP_DIR/build_thread-base_general.pid";
  ) &
  echo $! > "$TEMP_DIR/build_thread-base_general.pid"

  echo "Complete build of all installed systems started ...";
}

function buildThreadForOS()
{
  local system="$1"
  local caller="$2"
  local direct_build_cef=$3
  local direct_build_kodi=$4

  loadConfigFile

  if [ -f "$BASE_PATH/build/creation-kodi-$system.log" ];then
    mv "$BASE_PATH/build/creation-kodi-$system.log" "$BASE_PATH/build/creation-kodi-$system-`date +%F_%H-%m`.old.log";fi
  if [ -f "$BASE_PATH/build/creation-cef-$system.log" ];then
    mv "$BASE_PATH/build/creation-cef-$system.log" "$BASE_PATH/build/creation-cef-$system-`date +%F_%H-%m`.old.log";fi
  if [ -f "$BASE_PATH/build/creation-user-script0-$system.log" ];then
    mv "$BASE_PATH/build/creation-user-script-$system.log" "$BASE_PATH/build/creation-user-script-$system-`date +%F_%H-%m`.old.log";fi

  if [[ $INCLUDE_CEF = "TRUE" ]];then
    touch "$BASE_PATH/build/creation-cef-$system.log";fi

  if [[ $INCLUDE_KODI = "TRUE" ]];then
    touch "$BASE_PATH/build/creation-kodi-$system.log";fi

  if [[ $INCLUDE_USER_SCRIPT = "TRUE" ]];then
    touch "$BASE_PATH/build/creation-user-script-$system.log";fi

  if [[ $system = win* ]];then
  {
    . $HOME/.mupel/windows.conf;

    local ssh_port=2222
    local ssh_name=`echo "$WINDOWS_DEFAULT_RUN" | tr '(' '_' | tr ')' '_'`;

    if [[ -z `ps aux | grep qemu-system-x86_64 | grep emu-windows-` ]];then
    {
      echo "Found Windows not active and becomes started now ..."
      qemu-windows "$WINDOWS_DEFAULT_RUN" &
      sleep 5;
    } fi
  } fi

  if [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
  {
    . $HOME/.mupel/mac-osx.conf;

    local ssh_port=2223
    local ssh_name=`echo "$MAC_OS_X_DEFAULT_RUN" | tr '(' '_' | tr ')' '_'`;

    if [[ -z `ps aux | grep qemu-system-x86_64 | grep emu-mac-osx-` ]];then
    {
      echo "Found Mac OS X not active and becomes started now ..."
      qemu-mac-osx "$MAC_OS_X_DEFAULT_RUN" &
      sleep 5;
    } fi
  } fi

  if [[ $system = win* ]] || [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
  {
    printf "Checking ssh connection for independent OS build system (can take some seconds): ";
    for (( j = 1; j < $OS_START_TIMEOUT; ++ j ));do
    {
      if [[ -z `nmap 127.0.0.1 -PN -p $ssh_port | grep open` ]];then
        continue;fi

      local os_ready=1;
      break;
    } done
    if [ ! -z $os_ready ];then
      echo "connected";
    else
    {
      echo "failed, build interrupted!"
      return 1;
    } fi
  } fi

  (
    unset IFS;
    trap 'rm -f $TEMP_DIR/build_thread-cef_active; rm -f $TEMP_DIR/build_thread-cef_active-$system; rm -f $TEMP_DIR/build_thread-$system.pid;' EXIT SIGHUP SIGINT SIGTERM;
    sleep 3
    loadConfigFile

    step_cef=0
    step_kodi=0
    step_user=0
    bar_position=0;

    mutexLock_BaseBuild
    if [ $? = 0 ] && [ ! -f "$TEMP_DIR/build_thread-base_general.pid" ] && [[ $direct_build_cef = 0 ]] && [[ $direct_build_kodi = 0 ]];then
      buildThreadBaseGeneralProcess 0;fi
    mutexUnlock_BaseBuild

    while :;do
    {
      if [[ $INCLUDE_CEF = "TRUE" ]] && [[ $direct_build_kodi = 0 ]];then
      {
        if [[ $step_cef = 0 ]];then
        {
          if [ ! -f "$TEMP_DIR/build_thread-cef_active" ];then
          {
            local direct;
            if [[ $direct_build_cef = 1 ]];then
              direct="--build-direct";
            else
              direct="";fi

            touch "$TEMP_DIR/build_thread-cef_active";
            touch "$TEMP_DIR/build_thread-cef_active-$system";

            if [[ $system = win* ]];then
              sshpass -p $WINDOWS_SSH_PASSWORD ssh $ssh_name -l $WINDOWS_SSH_USERNAME -- bash --login "//10.0.2.4/qemu/build/tools/cef-$system.build" $direct >> "$BASE_PATH/build/creation-cef-$system.log" 2>&1 &
            elif [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
              $BASE_PATH/tools/cef-$system.build $direct >> "$BASE_PATH/build/creation-cef-$system.log" 2>&1 &
            else
              $caller bash "$BASE_PATH/tools/cef-$system.build" --temp-dir "$TEMP_DIR" $direct >> "$BASE_PATH/build/creation-cef-$system.log" 2>&1 &
            fi
            tail -f --pid=$! "$BASE_PATH/build/creation-cef-$system.log"

            rm -f $TEMP_DIR/build_thread-cef_active;
            rm -f $TEMP_DIR/build_thread-cef_active-$system;
            rm -f $TEMP_DIR/build_thread-$system.pid;

            step_cef=1;
            if [ -f $TEMP_DIR/cef-$system.failed ];then
            {
              rm $TEMP_DIR/cef-$system.failed
              showdialog --title="Warning" --image="$BASE_PATH/icons/icon-warning-128x128.png" \
                         --image-on-top --form --text="CEF $system creation failed! \nRelated build stopped." \
                         --button=gtk-ok:1 2> /dev/null &
              exit 1
            } fi
          }
          elif [[ $step_kodi = 1 ]] && [[ $step_user = 1 ]];then
          {
            local progress="";
            local bar_counter=0;
            while [ $bar_counter -lt 10 ];do
            {
              let bar_counter=bar_counter+1;
              if [[ $bar_position == $bar_counter ]];then
                progress=${progress}$BRIGHT$GREEN"|"$NORMAL;
              else
                progress=${progress}".";fi
            } done
            let bar_position=bar_position+1;
            if [ $bar_position -ge 10 ];then
              bar_position=0;fi

            printf "\rOther CEF build active, need finished before next start $WHITE[$NORMAL $progress $WHITE]$NORMAL";
            sleep 2;
            continue;
          } fi
        } fi
      }
      else
        step_cef=1;fi

      if [[ $INCLUDE_KODI = "TRUE" ]] && [[ $direct_build_cef = 0 ]];then
      {
        if [[ $step_kodi = 0 ]];then
        {
          local direct;
          if [[ $direct_build_kodi = 1 ]];then
            direct="--build-direct";
          else
            direct="";fi

          if [[ $system = win* ]];then
            sshpass -p $WINDOWS_SSH_PASSWORD ssh 127.0.0.1 -p 2222 -l $WINDOWS_SSH_USERNAME -- bash --login "//10.0.2.4/qemu/build/tools/kodi-$system.build" $direct >> "$BASE_PATH/build/creation-kodi-$system.log" 2>&1 &
          elif [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
            $BASE_PATH/tools/kodi-$system.build --temp-dir "$TEMP_DIR" $direct >> "$BASE_PATH/build/creation-kodi-$system.log" 2>&1 &
          else
            $caller bash "$BASE_PATH/tools/kodi-$system.build" --temp-dir "$TEMP_DIR" $direct >> "$BASE_PATH/build/creation-kodi-$system.log" 2>&1 &
          fi
          tail -f --pid=$! "$BASE_PATH/build/creation-kodi-$system.log";

          rm -f $TEMP_DIR/build_thread-$system.pid;
          if [ -f $TEMP_DIR/kodi-$system.failed ];then
          {
            rm $TEMP_DIR/kodi-$system.failed
            showdialog --title="Warning" --image="$BASE_PATH/icons/icon-warning-128x128.png" \
                       --image-on-top --form --text="Kodi $system creation failed! \nRelated build stopped." \
                       --button=gtk-ok:1 2> /dev/null &
            exit 1
          } fi

          step_kodi=1

          if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-$system/kodi.bin" ] ||
             [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-$system/kodiapp-x86-debug.apk" ];then
          {
            echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable 1";
            echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 1";
            parse_values "add-ons" "$system";
          }
          else
          {
            echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable 0";
            echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0";
          } fi
          continue;
        } fi
      }
      else
        step_kodi=1;fi

      if [[ $INCLUDE_USER_SCRIPT = "TRUE" ]] && [[ $direct_build_kodi = 0 ]] && [[ $direct_build_cef = 0 ]];then
      {
        if [[ $step_user = 0 ]];then
        {
          if [[ $system = win* ]];then
            sshpass -p $WINDOWS_SSH_PASSWORD ssh 127.0.0.1 -p 2222 -l $WINDOWS_SSH_USERNAME -- bash --login "//10.0.2.4/qemu/build/tools/user-script-$system.build" >> "$BASE_PATH/build/creation-user-script-$system.log" 2>&1 &
          elif [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
            $BASE_PATH/tools/user-script-$system.build --temp-dir "$TEMP_DIR" >> "$BASE_PATH/build/creation-user-script-$system.log" 2>&1 &
          else
            $caller bash "$BASE_PATH/tools/user-script-$system.build" --temp-dir "$TEMP_DIR" >> "$BASE_PATH/build/creation-user-script-$system.log" 2>&1 &
          fi
          tail -f --pid=$! "$BASE_PATH/build/creation-user-script-$system.log"

          step_user=1
          rm -f $TEMP_DIR/build_thread-$system.pid;
          if [ -f $TEMP_DIR/user_script-$system.failed ];then
          {
            rm $TEMP_DIR/user_script-$system.failed;
            showdialog --title="Warning" --image="$BASE_PATH/icons/icon-warning-128x128.png" \
                       --image-on-top --form --text="User script $system creation failed! \nRelated build stopped." \
                       --button=gtk-ok:1 2> /dev/null &
            exit 1
          } fi
        } fi
      }
      else
        step_user=1;fi

      if [[ $step_cef = 1 ]] && [[ $step_kodi = 1 ]] && [[ $step_user = 1 ]];then
      {
        printf "${BRIGHT}${WHITE}All build steps ${GREEN}successfully${WHITE} performed${NORMAL}\n";
        exit 0;
      } fi

      sleep 2
    } done
  ) &
  pid=$!

  echo $pid > "$TEMP_DIR/build_thread-$system.pid"
  echo "Build of $system started ...";
}

function buildThreadKodiAddonForOS()
{
  local system="$1"
  local caller="$2"
  local addon_name="$3"

  if [ -f "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log" ];then
    mv "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log" "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system-`date +%F_%H-%m`.old.log";fi

  touch "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log"
  (
    unset IFS;
    trap 'rm -f $TEMP_DIR/build_thread-$system.pid;' EXIT SIGHUP SIGINT SIGTERM;
    sleep 3
    loadConfigFile

    if [[ $system = win* ]];then
      sshpass -p $WINDOWS_SSH_PASSWORD ssh 127.0.0.1 -p 2222 -l $WINDOWS_SSH_USERNAME -- bash --login "//10.0.2.4/qemu/build/tools/kodi-addon-${addon_name}-$system.build --addon $addon_name" >> "$BASE_PATH/build/creation-kodi-addon-$system.log" 2>&1
    elif [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
      $BASE_PATH/tools/kodi-$system.build --temp-dir "$TEMP_DIR" --addon "$addon_name" >> "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log" 2>&1
    else
      $caller bash "$BASE_PATH/tools/kodi-$system.build" --temp-dir "$TEMP_DIR" --addon "$addon_name" >> "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log" 2>&1
    fi

    rm -f $TEMP_DIR/build_thread-$system.pid;
    if [ -f $TEMP_DIR/kodi-$system.failed ];then
    {
      rm $TEMP_DIR/kodi-$system.failed
      showdialog --title="Warning" \
          --image="$BASE_PATH/icons/icon-warning-128x128.png" \
          --image-on-top --form \
          --text="Kodi add-on $system for ${addon_name} creation failed! \nRelated build stopped." \
          --button=gtk-ok:1 2> /dev/null &
      exit 1
    } fi
  ) &
  pid=$!
  tail -f --pid=$pid "$BASE_PATH/build/creation-kodi-addon-${addon_name}-$system.log" &

  echo $pid > "$TEMP_DIR/build_thread-$system.pid"
  echo "Build of kodi add-on $system for ${addon_name} started ...";
}

function getLinuxTargetDist()
{
  dist_targets=$(ls /var/lib/chroot/ | grep 64bit | sed 's/64bit//g' | tr '\n'  '!');
  dist_targets=${dist_targets::-1};
  dist_targets=$(echo ${dist_targets//$USE_LINUX_X86_DISTR/\^${USE_LINUX_X86_DISTR}});
  echo $dist_targets
}

function getAndroidAVDS()
{
  local android_system=$1
  local android_avds=
  local android_avds_available=

  if [ -f $HOME/.mupel/android.conf ];then
  {
    . $HOME/.mupel/android.conf;
    if [ ! -f $ANDROID_DEV_ROOT/android-sdk-linux/tools/android ];then
      return 1;fi

    if [[ $android_system = x86 ]];then
      android_sel_avd=$ANDROID_SEL_AVD_X86;
    elif [[ $android_system = x86_64 ]];then
      android_sel_avd=$ANDROID_SEL_AVD_X86_64;
    elif [[ $android_system = arm ]];then
      android_sel_avd=$ANDROID_SEL_AVD_ARM;
    elif [[ $android_system = mips ]];then
      android_sel_avd=$ANDROID_SEL_AVD_MIPS;
    elif [[ $android_system = mips64 ]];then
      android_sel_avd=$ANDROID_SEL_AVD_MIPS64;
    else
      return 1;fi

    sel_target_version=$(echo $ANDROID_SEL_TARGET | awk -F '-' '{print $2}');

    IFS=$'\n'
    avd_device="-"
    declare -a android_avds=($($ANDROID_DEV_ROOT/android-sdk-linux/tools/android list avd))
    for (( i = 0; i < ${#android_avds[*]}; ++ i ));do
    {
      if [[ $(echo ${android_avds[i]} | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//') = Name* ]];then
      {
        avd_name=$(echo ${android_avds[i]} | awk -F ': ' '{print $2}');
        for (( j = 1; j < 6; ++ j ));do
        {
          value=$(echo ${android_avds[i+j]} | awk -F ': ' '{print $2}');
          if [[ ${android_avds[i+j]} = "  Device: "* ]];then
            avd_device=$value;
          elif [[ ${android_avds[i+j]} = "    Path: "* ]];then
            avd_path=$value;
          elif [[ ${android_avds[i+j]} = "  Target: "* ]];then
            avd_target=$value;
          elif [[ ${android_avds[i+j]} = " Tag/ABI: "* ]];then
            avd_tag_abi=$value;
          elif [[ ${android_avds[i+j]} = "    Skin: "* ]];then
            avd_skin=$value;fi
        } done

        echo $avd_tag_abi | grep -q $android_system;
        if [ $? != 0 ];then
          continue;fi

        if [[ $sel_target_version > $(echo $avd_target | awk -F 'API level ' '{print $2}' | awk -F ')' '{print $1}') ]];then
          continue;fi

        if [ -z $android_sel_avd ];then
          android_sel_avd=$avd_name;fi
        if [[ $avd_name = $android_sel_avd ]];then
          android_avds_available+="^";fi
        android_avds_available+="${avd_name}; API: $(echo ${avd_target} | awk -F 'level ' '{print $2}' | awk -F ')' '{print $1}'); Tag: $(echo ${avd_tag_abi} | awk -F '/' '{print $1}'); Device: ${avd_device}; ${avd_skin}!"
      } fi
    } done
    android_avds_available=${android_avds_available::-1};
    unset IFS;
  }
  else
    return 1;fi

  echo $android_avds_available;

  return 0;
}

# cleanup
function cleanup()
{
  rm -rf "$TEMP_DIR"

  # Remove temp files, from it knows the threads that they are finished
  rm -f "$thread1_in" \
        "$thread2_in" \
        "$thread3_in" \
        "$thread4_in" \
        "$thread5_in" \
        "$thread6_in" \
        "$thread7_in" \
        "$thread8_in" \
        "$thread9_in"
  sleep 1.5

  # Check after
  if [[ ! -z $pid_thread1 ]];then
    ps -p $pid_thread1; [[ $? = 0 ]] && killtree $pid_thread1 KILL;fi
  if [[ ! -z $pid_thread2 ]];then
    ps -p $pid_thread2; [[ $? = 0 ]] && killtree $pid_thread2 KILL;fi
  if [[ ! -z $pid_thread3 ]];then
    ps -p $pid_thread3; [[ $? = 0 ]] && killtree $pid_thread3 KILL;fi
  if [[ ! -z $pid_thread4 ]];then
    ps -p $pid_thread4; [[ $? = 0 ]] && killtree $pid_thread4 KILL;fi
  if [[ ! -z $pid_thread5 ]];then
    ps -p $pid_thread5; [[ $? = 0 ]] && killtree $pid_thread5 KILL;fi
  if [[ ! -z $pid_thread6 ]];then
    ps -p $pid_thread6; [[ $? = 0 ]] && killtree $pid_thread6 KILL;fi
  if [[ ! -z $pid_thread7 ]];then
    ps -p $pid_thread7; [[ $? = 0 ]] && killtree $pid_thread7 KILL;fi
  if [[ ! -z $pid_thread8 ]];then
    ps -p $pid_thread8; [[ $? = 0 ]] && killtree $pid_thread8 KILL;fi
  if [[ ! -z $pid_thread9 ]];then
    ps -p $pid_thread9; [[ $? = 0 ]] && killtree $pid_thread9 KILL;fi
}

function usage()
{
  echo "Usage: $0 [--options]"
  echo "Options:"
  echo "--info        Shows the information dialog"
  echo "--help        this help message"
  echo "Script will prompt interactively for other values."
  exit 1
}

function process_opts()
{
  while test "$1" != "" ; do
    case "$1" in
      --info)                   showSystemInfoDialog "Multi platform build environment for Kodi on Linux (Mupel)"
                                exit 0;;
      --help)                   usage;;
      *)
        echo "invalid command-line option: $OPTARG"
        usage
        ;;
    esac
    shift
  done
}

function getWindowsTargets()
{
  local windows_targets=;

  if [ -f "$HOME/.mupel/windows.conf" ];then
  {
    . "$HOME/.mupel/windows.conf";

    windows_targets=$(ls -d $HOME/.mupel/emulate/emu-windows* | awk -F"/" '{print $NF}' | tr '\n'  '!');
    windows_targets=${windows_targets::-1};
    windows_targets=$(echo ${windows_targets//$WINDOWS_DEFAULT_RUN/\^${WINDOWS_DEFAULT_RUN}});
  } fi
  echo $windows_targets;
  return 0;
}

function getMacOSXTargets()
{
  local macosx_targets=;

  if [ -f "$HOME/.mupel/mac-osx.conf" ];then
  {
    . "$HOME/.mupel/mac-osx.conf";

    macosx_targets=$(ls -d $HOME/.mupel/emulate/emu-mac-osx* | awk -F"/" '{print $NF}' | tr '\n'  '!');
    macosx_targets=${macosx_targets::-1};
    macosx_targets=$(echo ${macosx_targets//$MAC_OS_X_DEFAULT_RUN/\^${MAC_OS_X_DEFAULT_RUN}});
  } fi
  echo $macosx_targets;
  return 0;
}

function getAndroidTargets()
{
  local android_targets=;
  IFS=$' '

  if [ -f "$HOME/.mupel/android.conf" ];then
  {
    . "$HOME/.mupel/android.conf";

    if [ ! -f "$ANDROID_DEV_ROOT/android-sdk-linux/tools/android" ];then
    {
      printf "${RED}${BRIGHT}Not possible to use android, failure in system! ${NORMAL}\n" > /dev/stderr;
      return 1;
    } fi
    android_targets=$($ANDROID_DEV_ROOT/android-sdk-linux/tools/android list targets | grep "android-" | awk -F '"' '{print $2}' | tr '\n' '!');
    android_targets=${android_targets::-2};
    android_targets=$(echo ${android_targets//$ANDROID_SEL_TARGET/\^${ANDROID_SEL_TARGET}});
  } fi
  echo $android_targets;
  return 0;
}

function showAndroidEmulatorKeyHelp()
{
  showdialog --skip-taskbar --on-top \
             --title="Android Emulator Keys" \
             --image="$BASE_PATH/icons/icon-info-128x128.png" \
             --image-on-top --form \
             --button=gtk-ok:0 \
             --width=830 --show-uri --editable \
             --text-info \
             --text="<tt>
  When running the emulator, use the following keypresses:

    Home                    Home button
    F2, PageUp              Menu (Soft-Left) button
    Shift-F2, PageDown      Star (Soft-Right) button
    Escape                  Back button
    F3                      Call/Dial button
    F4                      Hangup/EndCall button
    F7                      Power button
    F5                      Search button
    Keypad_Plus, Ctrl-F5    Volume up button
    Keypad_Minus, Ctrl-F6   Volume down button
    Ctrl-Keypad_5, Ctrl-F3  Camera button
    Keypad_7, Ctrl-F11      Switch to previous layout
    Keypad_9, Ctrl-F12      Switch to next layout
    F8                      Toggle cell network on/off
    F9                      Toggle fullscreen mode
    F6                      Toggle trackball mode
    Delete                  Show trackball
    Keypad_5                DPad center
    Keypad_4                DPad left
    Keypad_6                DPad right
    Keypad_8                DPad up
    Keypad_2                DPad down
    Keypad_Multiply         Increase onion alpha
    Keypad_Divide           Decrease onion alpha

  note that NumLock must be deactivated for keypad keys to work</tt>" 2> /dev/null
}

function showGitCommandHelp()
{
  showdialog --skip-taskbar --on-top \
             --title="Git commands" \
             --image="$BASE_PATH/icons/icon-info-64x64.png" \
             --image-on-top \
             --button=gtk-ok:0 \
             --width=830 --height=600 \
             --text-info \
             --filename="$BASE_PATH/help/git-help.txt" \
             --text="<tt><b><i><span size=\"large\">Usable Git commands:</span></i></b></tt>" 2> /dev/null
}

function ssh_access_windows()
{
  if [[ $USE_MS_WINDOWS_32 != "TRUE" ]] && [[ $USE_MS_WINDOWS_64 != "TRUE" ]];then
  {
    showErrorDialog "<b>\
Use of Windows not installed or enabled.

SSH access console not possible!</b>"
    return
  }
  elif [[ ! -f $HOME/.mupel/windows.conf ]];then
  {
    showErrorDialog "<b>\
Needed Windows configuration file missing.

SSH access console not possible!</b>"
    return
  }
  elif [[ ! -f $BASE_PATH/tools/mac-osx/open-ssh-console-access ]];then
  {
    showErrorDialog "<b>\
Needed Windows SSH access script file missing:</b>
 - $BASE_PATH/tools/windows/open-ssh-console-access

<b>SSH access console not possible!</b>"
    return
  } fi

  $BASE_PATH/tools/windows/open-ssh-console-access
}

function ssh_access_mac_os_x()
{
  if [[ $USE_MAC_OS_X_32 != "TRUE" ]] && [[ $USE_MAC_OS_X_64 != "TRUE" ]];then
  {
    showErrorDialog "<b>\
Use of Mac OS X not installed or enabled.

SSH access console not possible!</b>"
    return
  }
  elif [[ ! -f $HOME/.mupel/mac-osx.conf ]];then
  {
    showErrorDialog "<b>\
Needed Mac OS X configuration file missing.

SSH access console not possible!</b>"
    return
  }
  elif [[ ! -f $BASE_PATH/tools/mac-osx/open-ssh-console-access ]];then
  {
    showErrorDialog "<b>\
Needed Mac OS X SSH access script file missing:</b>
 - $BASE_PATH/tools/mac-osx/open-ssh-console-access

<b>SSH access console not possible!</b>"
    return
  } fi


  $BASE_PATH/tools/mac-osx/open-ssh-console-access
}

function forceKodiSelectedBuild()
{
  unset IFS;
  local system="$1"
  local caller="$2"
  local kodi_buildstep="$3"

  # Force process active to have right stop from here
  process_active=1

  if [ ! -d $BASE_PATH/build/kodi-$GIT_USER/kodi-$system ];then
    loadKodiBuildDir $system $system;fi

  # Ask user to pick one of the available targets
  local targets="$(cd $BASE_PATH/build/kodi-$GIT_USER/kodi-$system/tools/buildsteps/$kodi_buildstep; ls)"
  local selection="";
  for i in $targets; do
    selection=`printf "$selection FALSE %s" "$i"`;done

  while :; do
  {
    selection=$(showdialog --list \
                           --title="Selectable direct build" \
                           --text="The following Kodi direct build steps are available:" \
                           --radiolist \
                           --column "Use" \
                           --column "Type" \
                           --print-column=2 \
                           $selection \
                           --width=400 --height=390 2> /dev/null)
    selection=${selection%|};
    if [ -z $selection ];then
    {
      showWarningDialog_YesNo "No step selected! \n\nTry again?"
      [ $? != 0 ] && return;
    }
    else
      break;fi
  } done

  if [ -f "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log" ];then
    mv "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log" "$BASE_PATH/build/creation-kodi-selected-$selection-$system-`date +%F_%H-%m`.old.log";fi
  touch "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log"
  (
    sleep 3
    loadConfigFile

    if [[ $system = win* ]];then
      printf "${RED}${BRIGHT}Selection build for Windows not possible!${NORMAL}\n";
    elif [[ $system = osx* ]] || [[ $system = ios ]] || [[ $system = atv2 ]];then
      $BASE_PATH/tools/kodi-$system.build --temp-dir "$TEMP_DIR" --selected $selection >> "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log" 2>&1
    else
      $caller bash "$BASE_PATH/tools/kodi-$system.build" --temp-dir "$TEMP_DIR" --selected $selection >> "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log" 2>&1
    fi

    rm -f $TEMP_DIR/build_thread-$system.pid;
    if [ -f $TEMP_DIR/kodi-$system.failed ];then
    {
      rm $TEMP_DIR/kodi-$system.failed
      showdialog --title="Warning" \
          --image="$BASE_PATH/icons/icon-warning-128x128.png" \
          --image-on-top --form \
          --text="Kodi $system for selection $selected creation failed! \nRelated build stopped." \
          --button=gtk-ok:1 2> /dev/null &
      exit 1
    } fi
  ) &
  pid=$!
  tail -f --pid=$pid "$BASE_PATH/build/creation-kodi-selected-$selection-$system.log" &

  echo $pid > "$TEMP_DIR/build_thread-$system.pid"
  echo "Build of kodi $system part for $selected started ...";
}


}
#
###############################################################################


###-------------------------------------------------------------------------###
#                                                                             #
#                            Start of process points                          #
#                                                                             #
[[ $DIST != "Ubuntu" ]] && [[ $DIST != "Debian" ]] && {
  echo "${RED}${BRIGHT}Build not possible, need performed on ubuntu or debian based system (needed for install of dependencies parts)${NORMAL}" > /dev/stderr
  exit 1 ;
}

# Check that xserver is running and user is root.
[[ $DISPLAY ]] || {
  echo $"${RED}${BRIGHT}There is no xserver running. Exiting...${NORMAL}";
  exit 1;
}

# Check that we are running as a regular user
[ "$(id -nu)" = root ] && {
  printf "${RED}${BRIGHT}Run this script as a regular user and provide your \"sudo\" password if requested!${NORMAL}\n" > /dev/stderr
  exit 1;
}

unset IFS;

process_opts "$@";

mutexUnlock_ConfigFile
mutexUnlock_BaseBuild

##
# Due to sometimes problems of the big app chain from yad make sure on start of
# them here every else is killed, due to the separate name used on this is it
# not direct problematic on system but a hack way
killall $basic_dialog -q;

$basic_dialog --html --width=644 --height=478 --uri=/home/alwin/mupel/icons/mupel-start-image.png --undecorated --no-buttons --sticky --on-top --center --skip-taskbar &
start_dialog_pid=$!;
sleep 1.5

SYSTEM_ACTIVE=1;

DEBUG=
KEY=$RANDOM
if [ -z $DEBUG ];then
{
  TEMP_DIR=$(mktemp -d);
}
else
{
  echo "Debug mode enabled";
  TEMP_DIR=`pwd`/tmp;
  mkdir $TEMP_DIR;
} fi

thread1_in=${TEMP_DIR}/thread1_in
touch ${TEMP_DIR}/thread1_in
thread2_in=${TEMP_DIR}/thread2_in
touch ${TEMP_DIR}/thread2_in
thread3_in=${TEMP_DIR}/thread3_in
touch ${TEMP_DIR}/thread3_in
thread4_in=${TEMP_DIR}/thread4_in
touch ${TEMP_DIR}/thread4_in
thread5_in=${TEMP_DIR}/thread5_in
touch ${TEMP_DIR}/thread5_in
thread6_in=${TEMP_DIR}/thread6_in
touch ${TEMP_DIR}/thread6_in
thread7_in=${TEMP_DIR}/thread7_in
touch ${TEMP_DIR}/thread7_in
thread8_in=${TEMP_DIR}/thread8_in
touch ${TEMP_DIR}/thread8_in
thread9_in=${TEMP_DIR}/thread9_in
touch ${TEMP_DIR}/thread9_in

###############################################################################
# Thread one: General handling
{
  (
    PULSE_ON=0;
    enabled=1
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        sleep 2;
        continue;
      } fi

      loadConfigFile

      # Set buttons to initial state
      echo "#> msg field $GEN__BTN______START_BUILD_ALL:visible 1;";
      echo "#> msg field $GEN__BTN_______STOP_BUILD_ALL:visible 0;";
      echo "#> msg field $GEN__BTN______________DUMMY_1:visible 0;"; # Dummy
      echo "#> msg field $GEN__BTN______________DUMMY_2:visible 0;"; # Dummy
      if [[ $USE_LINUX_X86_32 = "FALSE" ]] &&
         [[ $USE_LINUX_X86_64 = "FALSE" ]] &&
         [[ $USE_LINUX_RPBI = "FALSE" ]] &&
         [[ $USE_MS_WINDOWS_32 = "FALSE" ]] &&
         [[ $USE_MS_WINDOWS_64 = "FALSE" ]] &&
         [[ $USE_MAC_OS_X_32 = "FALSE" ]] &&
         [[ $USE_MAC_OS_X_64 = "FALSE" ]] &&
         [[ $USE_ANDROID_ARM = "FALSE" ]] &&
         [[ $USE_ANDROID_X86 = "FALSE" ]] &&
         [[ $USE_IOS_ATV2 = "FALSE" ]];then
      {
        echo "#> msg field $GEN__BTN______START_BUILD_ALL:enable 0;";
        echo "#> msg field $GEN__BTN____CREATE_INST_MUPEL:visible 1;";
        echo "#> msg field $GEN__BTN____CREATE_INST_MUPEL:enable 1;";
        enabled=0;
      }
      else
      {
        echo "#> msg field $GEN__BTN______START_BUILD_ALL:enable 1;";
        echo "#> msg field $GEN__BTN____CREATE_INST_MUPEL:visible 0;";
      } fi

      echo "#> msg field $GEN__CHK_________INCLUDE_KODI:set $INCLUDE_KODI;";
      echo "#> msg field $GEN__CHK__INCLUDE_KODI_ADDONS:set $INCLUDE_KODI_ADDONS;";
      echo "#> msg field $GEN__CHK__________INCLUDE_CEF:set $INCLUDE_CEF;";
      [[ $SUPPORT_CEF = "TRUE" ]] && echo "#> msg field $GEN__CHK__________INCLUDE_CEF:enable 1;" || echo "#> msg field $GEN__CHK__________INCLUDE_CEF:enable 0;";

      sleep 2
      kill $start_dialog_pid

      # Main loop
      while :;do
      {
        if [ ! -f "$thread1_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          echo "#> msg field $GEN__BTN____CREATE_INST_MUPEL:enable 0;";
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        if [[ $enabled = 0 ]] && [ -z $DEBUG ];then
        {
          echo "No systems available, starting install" > /dev/stderr
          bash $BASE_PATH/mupel-install --main-msg $thread1_in;
        } fi

        proc=$(cat "$thread1_in")
        echo -n "" > "$thread1_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_build"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $GEN__BTN______START_BUILD_ALL:visible 0;";
              echo "#> msg field $GEN__BTN_______STOP_BUILD_ALL:visible 1;";
              echo "#> msg field $GEN__BTN______DOWNLOAD_UPDATE:enable 0;";
              echo "#> msg field $GEN__BTN____CREATE_NEW_BRANCH:enable 0;";
              echo "#> msg field $GEN__CHK_________INCLUDE_KODI:enable 0;";
              echo "#> msg field $GEN__CHK__INCLUDE_KODI_ADDONS:enable 0;";
              echo "#> msg field $GEN__CHK__________INCLUDE_CEF:enable 0;";
              PULSE_ON=1

              buildThreadBaseGeneral
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              [[ $USE_LINUX_X86_32 = "TRUE" ]]  ||
              [[ $USE_LINUX_X86_64 = "TRUE" ]]  && echo "#< msg stop_build;" >> "$thread3_in"
              [[ $USE_LINUX_RPBI = "TRUE" ]]    && echo "#< msg stop_build;" >> "$thread4_in"
              [[ $USE_MS_WINDOWS_32 = "TRUE" ]] ||
              [[ $USE_MS_WINDOWS_64 = "TRUE" ]] && echo "#< msg stop_build;" >> "$thread5_in"
              [[ $USE_MAC_OS_X_32 = "TRUE" ]]   ||
              [[ $USE_MAC_OS_X_64 = "TRUE" ]]   && echo "#< msg stop_build;" >> "$thread6_in"
              [[ $USE_ANDROID_ARM = "TRUE" ]]   ||
              [[ $USE_ANDROID_X86 = "TRUE" ]]   && echo "#< msg stop_build;" >> "$thread7_in"
              [[ $USE_IOS_ATV2 = "TRUE" ]]      && echo "#< msg stop_build;" >> "$thread8_in"

              if [ -f "$TEMP_DIR/build_thread-base_general.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-base_general.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-base_general.pid"
                killall git
                killall python
                rm -f "$TEMP_DIR/.tempLoggerActive"
              } fi
              echo ""
              if [[ $PULSE_ON = 1 ]];then
              {
                echo "#> msg pulse off;";
                PULSE_ON=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $GEN__BTN______START_BUILD_ALL:visible 1;";
              echo "#> msg field $GEN__BTN_______STOP_BUILD_ALL:visible 0;";
              echo "#> msg field $GEN__CHK_________INCLUDE_KODI:enable 1;";
              echo "#> msg field $GEN__CHK__INCLUDE_KODI_ADDONS:enable 1;";
              echo "#> msg field $GEN__CHK__________INCLUDE_CEF:enable 1;";
              echo "#> msg field $GEN__CHK_________INCLUDE_KODI:enable 1;";
              echo "#> msg field $GEN__CHK__INCLUDE_KODI_ADDONS:enable 1;";
            }
            elif [[ "$line" = *"download_only"* ]];then
            {
              mutexLock_BaseBuild
              echo "#> msg field $GEN__BTN______DOWNLOAD_UPDATE:enable 0;";
              if [ $? = 0 ];then
                buildThreadBaseGeneralProcess 0;fi
              echo "#> msg field $GEN__BTN______DOWNLOAD_UPDATE:enable 1;";
              mutexUnlock_BaseBuild
            }
            elif [[ "$line" = *"kodi_prepare_patches"* ]];then
            {
              unset IFS;
              printf "\
/------------------------------------------------------------------------------

${BRIGHT}${WHITE}Prepare each commit with its patch in one file per commit ...${NORMAL}
"
              git -C $BASE_PATH/build/kodi-$GIT_USER/kodi format-patch origin -o $BASE_PATH/build/kodi-$GIT_USER
              printf "\
${BRIGHT}${WHITE}Done for '$BASE_PATH/build/kodi-$GIT_USER/kodi'${NORMAL}

\\-------------------------------------------------------------------------------\n"
            }
            elif [[ "$line" = *"kodi_new_branch"* ]];then
            {
              unset IFS;
              echo "#> msg field $GEN__BTN____CREATE_NEW_BRANCH:enable 0;";
              while :;do
              {
                new_kodi_branch=$(showdialog --entry \
                                             --title="New kodi branch" \
                                             --text="<b>Enter new kodi branch name</b>\nBecomes also loaded up if possible" \
                                             --width=260 --center);
                if [[ ! -z  `echo $new_kodi_branch | grep " "` ]];then
                {
                  showErrorDialog_YesNo "<b>Your new branch contains not allowed spaced</b>\n - '${new_kodi_branch}'\n\nDo you want to try again?";
                  [ $? != 0 ] && break;
                  continue;
                } fi
                if [ ! -z $new_kodi_branch ];then
                {
                  printf "\
/------------------------------------------------------------------------------

${BRIGHT}${WHITE}Creating new kodi branch '$new_kodi_branch' ...${NORMAL}
"
                git -C $BASE_PATH/build/kodi-$GIT_USER/kodi checkout master
                git -C $BASE_PATH/build/kodi-$GIT_USER/kodi checkout -b $new_kodi_branch;
                # If new branch is not on kodi source from github.com/xbmc and is loaded
                # with access rights ask to upload new branch
                if [ $GIT_USER != xbmc ] && [ ! -z `echo $KODI_SOURCE_URL | grep ":" | grep "@"` ];then
                {
                  showQuestionDialog "Do you want also upload '$new_kodi_branch' to $KODI_SOURCE_URL?";
                  if [ $? = 0 ];then
                    git -C $BASE_PATH/build/kodi-$GIT_USER/kodi push --set-upstream origin $new_kodi_branch;fi
                } fi;
                git -C $BASE_PATH/build/kodi-$GIT_USER/kodi checkout $KODI_SOURCE_BRANCH
                # Trigger to reload available branches
                echo "#< msg field 2:$KODI_SOURCE_URL;" >> $thread9_in

                printf "\
${BRIGHT}${WHITE}Done for '$BASE_PATH/build/kodi-$GIT_USER/kodi'${NORMAL}

\\-------------------------------------------------------------------------------\n"
                } fi
                break;
              } done
              echo "#> msg field $GEN__BTN____CREATE_NEW_BRANCH:enable 1;";
            }
            elif [[ "$line" = *"delete_old_logs"* ]];then
            {
              unset IFS;
              echo "#> msg field $GEN__BTN____DEL_OLD_LOG_FILES:enable 0;";

              if [[ ! -z  `ls $BASE_PATH/build/*.old.log 2> /dev/null` ]];then
              {
                showWarningDialog_YesNo "<b>\
All old log files with '*.old.log' becomes deleted!

Are you sure?</b>"
                if [ $? = 0 ];then
                  rm -vf $BASE_PATH/build/*.old.log;fi
              }
              else
                echo "No old log files present, skipped.";fi

              echo "#> msg field $GEN__BTN____DEL_OLD_LOG_FILES:enable 1;";
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "general" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                  {
                    parse_values "general" $id2 "$value2"
                    ((id2++))
                  } done;
                fi; IFS=$'\n';
              done; unset IFS;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
            {
              echo "Wrong command! $line" > /dev/stderr
            } fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-base_general.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          #echo "#< msg stop_build;" >> "$thread1_in";
          process_active=0;
        } fi

        sleep 0.5;
      } done
    } done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=1 --form \
            --text="General settings" \
            --pulsate \
            --xcom-log=$thread1_in \
            --field="Start build all:FBTN@0,8,0,2" "bash -c 'echo \"#< msg start_build;\" > $thread1_in'" \
            --field="Stop build all:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build;\" > $thread1_in'" \
            --field="Create and install Mupel system:FBTN@0,8,4,6" "bash $BASE_PATH/mupel-install --main-msg $thread1_in" \
            --field="dummy:FBTN@8,8,4,6" "" \
            --field="Download/Update only:FBTN@0,0,12,14" "bash -c 'echo \"#< msg download_only;\" > $thread1_in'" \
            --field="Create new branch:FBTN@1,1,12,14" "bash -c 'echo \"#< msg kodi_new_branch;\" > $thread1_in'" \
            --field="Prepare patches:FBTN@2,2,12,14" "bash -c 'echo \"#< msg kodi_prepare_patches;\" > $thread1_in'" \
            --field="Delete old log files:FBTN@7,7,12,14" "bash -c 'echo \"#< msg delete_old_logs;\" >> $thread1_in'" \
            --field="Clear log:FBTN@8,8,12,14" "bash -c 'echo \"#> msg field 15:clear;\" >> $thread1_in'" \
            --field=":lbl@0,8,16,18" \
            --field="Include Kodi:chk@0,0,20,22" $INCLUDE_KODI \
            --field="Include Kodi add-ons:chk@1,1,20,22" $INCLUDE_KODI_ADDONS \
            --field="Include CEF:chk@2,2,20,22" $INCLUDE_CEF \
            --field="dummy:FBTN@0,1,24,26" "" \
            --field="Build log:termproc@0,9,28,30" ""  &
  pid_thread1=$!
}
#
###############################################################################

TAB_LIST=
TAB_NUM=2

###############################################################################
# Thread two: GIT Handling
(
  sleep 0.5;

  pulse_on=0;
  process_active=0

  while :;do
  {
    if [ -f ./build/global_mupel_install ];then
    {
      [ -z $SYSTEM_ACTIVE ] && exit 0;
      sleep 2;
      continue;
    } fi

    loadConfigFile

    # Main loop
    while :;do
    {
      if [ ! -f "$thread2_in" ];then
        exit 0;fi

      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        break;
      } fi

      if [ -z $SYSTEM_ACTIVE ];then
        echo "#> msg field -1:values;";fi

      proc="$(cat "$thread2_in")"
      echo -n "" > "$thread2_in";
      IFS=$'\n';
      for line in ${proc}; do
      {
        if [[ "$line" == "#< msg"* ]];then
        {
          echo "Wrong command! $line" > /dev/stderr;
        }
        else
        {
          echo "$line"
        } fi
      } done

      sleep 1;
    } done
  }
  done
) | \
yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
           --text="Git checks" \
           --pulsate \
           --xcom-log=$thread2_in \
           --field="<b>TODO</b>:LBL@0,8,10,11" '' > /dev/null 2>&1 &
pid_thread2=$!

TAB_LIST+="--tab=Git checks "
((TAB_NUM++))

#
###############################################################################

###############################################################################
# Thread three: Handle Linux 64 bit
if [[ $USE_LINUX_X86_32 = "TRUE" ]] || [[ $USE_LINUX_X86_64 = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-$LINUX_BUILD_TYPE/kodi.bin" ];then
      {
        kodi_direct=1
        parse_values "add-ons" "linux-$LINUX_BUILD_TYPE"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $([ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-$LINUX_BUILD_TYPE/Makefile" ] && echo 1 || echo 0);";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";

      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-linux-$LINUX_BUILD_TYPE.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread3_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread3_in")"
        echo -n "" > "$thread3_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              [ $LINUX_BUILD_TYPE = x86_64 ] && BITSIZE=64 || BITSIZE=32;

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "linux-$LINUX_BUILD_TYPE" "${USE_LINUX_X86_DISTR}${BITSIZE}" $is_direct_cef $is_direct_kodi;
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "linux-$LINUX_BUILD_TYPE" "${USE_LINUX_X86_DISTR}${BITSIZE}" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                forceKodiSelectedBuild "linux-$LINUX_BUILD_TYPE" "${USE_LINUX_X86_DISTR}${BITSIZE}" linux${BITSIZE};fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-linux-$LINUX_BUILD_TYPE.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-linux-$LINUX_BUILD_TYPE.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-linux-$LINUX_BUILD_TYPE.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-$LINUX_BUILD_TYPE/kodi.bin" ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $([ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-$LINUX_BUILD_TYPE/Makefile" ] && echo 1 || echo 0);";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-linux-$LINUX_BUILD_TYPE.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
                git -C "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-$LINUX_BUILD_TYPE" clean -dffx;
                echo "Cleanup done"
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
                echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable 0;";
                echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable 0;";
                echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
                echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";
              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-linux-$LINUX_BUILD_TYPE.log \
                $BASE_PATH/build/creation-cef-linux-$LINUX_BUILD_TYPE.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "linux-$LINUX_BUILD_TYPE" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "linux-$LINUX_BUILD_TYPE" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-linux-$LINUX_BUILD_TYPE.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread3_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Linux x86 (Debian/Ubuntu based)" \
             --pulsate \
             --xcom-log=$thread3_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread3_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread3_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread3_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread3_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread3_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field 12:clear;\" >> $thread3_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread3_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-linux-$LINUX_BUILD_TYPE $thread3_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread3_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread3_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread3=$!

  TAB_LIST+="--tab=Linux-x86 "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread four: Handle Linux Raspberry PI
if [[ $USE_LINUX_RPBI = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-rpbi/kodi.bin" ];then
      {
        kodi_direct=1
        parse_values "add-ons" "linux-rpbi"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $([ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-rpbi/Makefile" ] && echo 1 || echo 0);";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";

      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-linux-rpbi.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread4_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread4_in")"
        echo -n "" > "$thread4_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "linux-rpbi" "${USE_LINUX_X86_DISTR}32" $is_direct_cef $is_direct_kodi;
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "linux-rpbi" "${USE_LINUX_X86_DISTR}32" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                forceKodiSelectedBuild "linux-rpbi" "${USE_LINUX_X86_DISTR}32" linux32;fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-linux-rpbi.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-linux-rpbi.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-linux-rpbi.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-rpbi/kodi.bin" ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $([ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-rpbi/Makefile" ] && echo 1 || echo 0);";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-linux-rpbi.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
                git -C "$BASE_PATH/build/kodi-$GIT_USER/kodi-linux-rpbi" clean -dffx;
                echo "Cleanup done"
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
                echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable 0;";
                echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable 0;";
                echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
                echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";
              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-linux-rpbi.log \
                $BASE_PATH/build/creation-cef-linux-rpbi.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "linux-rpbi" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "linux-rpbi" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-linux-rpbi.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread4_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Linux Raspberry PI build" \
             --pulsate \
             --xcom-log=$thread4_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread4_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread4_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread4_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread4_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread4_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;\" >> $thread4_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread4_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-linux-rpbi $thread4_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread4_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread4_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread4=$!

  TAB_LIST+="--tab=Linux-Raspberry-PI "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread five: Handle Windows
if [[ $USE_MS_WINDOWS_32 = "TRUE" ]] || [[ $USE_MS_WINDOWS_64 = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      . "$HOME/.mupel/windows.conf";

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-win-${WINDOWS_BUILD_TYPE}/kodi.bin" ];then
      {
        kodi_direct=1
        parse_values "add-ons" "win-${WINDOWS_BUILD_TYPE}"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:visible 0;"; # Hide "Launch Kodi" until a good way is found to start on windows
      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:visible 0;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-win-${WINDOWS_BUILD_TYPE}.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread5_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread5_in")"
        echo -n "" > "$thread5_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "win-${WINDOWS_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" $is_direct_cef $is_direct_kodi;
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "win-${WINDOWS_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                echo "NOT SUPPORTED!";fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-win-${WINDOWS_BUILD_TYPE}.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-win-${WINDOWS_BUILD_TYPE}.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-win-${WINDOWS_BUILD_TYPE}.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-win-${WINDOWS_BUILD_TYPE}/kodi.bin" ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-win-${WINDOWS_BUILD_TYPE}.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "NOT SUPPORTED!";







              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-win-$WINDOWS_BUILD_TYPE.log \
                $BASE_PATH/build/creation-cef-win-$WINDOWS_BUILD_TYPE.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "win-${WINDOWS_BUILD_TYPE}" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "win-${WINDOWS_BUILD_TYPE}" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-win-${WINDOWS_BUILD_TYPE}.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread5_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Windows build" \
             --pulsate \
             --xcom-log=$thread5_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread5_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread5_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread5_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread5_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread5_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;\" >> $thread5_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread5_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-win32 $thread5_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread5_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread5_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread5=$!

  TAB_LIST+="--tab=Microsoft-Windows "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread six: Handle Mac OS X
if [[ $USE_MAC_OS_X_32 = "TRUE" ]] || [[ $USE_MAC_OS_X_64 = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      . "$HOME/.mupel/mac-osx.conf";
      export MAC_OS_X_BUILD_TYPE=$MAC_OS_X_BUILD_TYPE;

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-osx-${MAC_OS_X_BUILD_TYPE}/kodi.bin" ];then
      {
        kodi_direct=1
        parse_values "add-ons" "osx-${MAC_OS_X_BUILD_TYPE}"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";

      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-osx-${MAC_OS_X_BUILD_TYPE}.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread6_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread6_in")"
        echo -n "" > "$thread6_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "osx-${MAC_OS_X_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" $is_direct_cef $is_direct_kodi;
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "osx-${MAC_OS_X_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                forceKodiSelectedBuild "osx-${MAC_OS_X_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" osx${MAC_OS_X_BUILD_TYPE};fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-osx-${MAC_OS_X_BUILD_TYPE}.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-osx-${MAC_OS_X_BUILD_TYPE}.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-osx-${MAC_OS_X_BUILD_TYPE}.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-osx-${MAC_OS_X_BUILD_TYPE}/kodi.bin" ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-osx-${MAC_OS_X_BUILD_TYPE}.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "NOT SUPPORTED!";







              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-osx-${MAC_OS_X_BUILD_TYPE}.log \
                $BASE_PATH/build/creation-cef-osx-${MAC_OS_X_BUILD_TYPE}.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "osx-${MAC_OS_X_BUILD_TYPE}" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "osx-${MAC_OS_X_BUILD_TYPE}" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-osx-${MAC_OS_X_BUILD_TYPE}.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread6_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Mac OS X build" \
             --pulsate \
             --xcom-log=$thread6_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread6_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread6_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread6_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread6_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread6_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;\" >> $thread6_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread6_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-osx32 $thread6_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread6_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread6_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread6=$!

  TAB_LIST+="--tab=Mac-OS-X "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread seven: Handle Android
if [[ $USE_ANDROID_ARM = "TRUE" ]] || [[ $USE_ANDROID_X86 = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      . "$HOME/.mupel/android.conf";

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f $BASE_PATH/build/kodi-$GIT_USER/kodi-android-x86/*.apk ];then
      {
        kodi_direct=1
        parse_values "add-ons" "android-x86"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";

      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-android-${ANDROID_BUILD_TYPE}.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread7_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread7_in")"
        echo -n "" > "$thread7_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "android-${ANDROID_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" $is_direct_cef $is_direct_kodi
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "android-${ANDROID_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                forceKodiSelectedBuild "android-${ANDROID_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" `[ ${ANDROID_BUILD_TYPE} = x86 ] && echo androidx86 || echo android`;fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-android-${ANDROID_BUILD_TYPE}.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-android-${ANDROID_BUILD_TYPE}.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-android-${ANDROID_BUILD_TYPE}.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f $BASE_PATH/build/kodi-$GIT_USER/kodi-android-${ANDROID_BUILD_TYPE}/*.apk ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-android-${ANDROID_BUILD_TYPE}.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
                git -C "$BASE_PATH/build/kodi-$GIT_USER/kodi-android-${ANDROID_BUILD_TYPE}" clean -dffx;
                echo "Cleanup done"
                echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
                echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable 0;";
                echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable 0;";
                echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
                echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";
              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-android-${ANDROID_BUILD_TYPE}.log \
                $BASE_PATH/build/creation-cef-android-${ANDROID_BUILD_TYPE}.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "android-${ANDROID_BUILD_TYPE}" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "android-${ANDROID_BUILD_TYPE}" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-android-${ANDROID_BUILD_TYPE}.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread7_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Android" \
             --pulsate \
             --xcom-log=$thread7_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread7_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread7_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread7_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread7_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread7_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;\" >> $thread7_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread7_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-android-${ANDROID_BUILD_TYPE} $thread7_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread7_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread7_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread7=$!

  TAB_LIST+="--tab=Android "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread eight: Handle IOS ATV2
if [[ $USE_IOS_ATV2 = "TRUE" ]];then
{
  (
    sleep 0.5;

    pulse_on=0;
    process_active=0

    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      . "$HOME/.mupel/mac-osx.conf";

      # Set buttons to initial state
      echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
      echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
      if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-${IOS_ATV2_BUILD_TYPE}/kodi.bin" ];then
      {
        kodi_direct=1
        parse_values "add-ons" "${IOS_ATV2_BUILD_TYPE}"
      }
      else
        kodi_direct=0;fi
      echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";

      echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
      echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
      echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
      echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-${IOS_ATV2_BUILD_TYPE}.active" ] && echo 1 || echo 0);";

      # Main loop
      while :;do
      {
        if [ ! -f "$thread8_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        if [ -z $SYSTEM_ACTIVE ];then
          echo "#> msg field -1:values;";fi

        proc="$(cat "$thread8_in")"
        echo -n "" > "$thread8_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"start_direct_build_kodi"* ]];then
              is_direct_kodi=1
            else
              is_direct_kodi=0;fi
            if [[ "$line" = *"start_direct_build_cef"* ]];then
              is_direct_cef=1
            else
              is_direct_cef=0;fi

            if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]] ||
               [[ "$line" = *"start_addon_build"* ]] || [[ "$line" = *"kodi_force_build_step"* ]];then
            {
              echo "#> msg pulse on;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 0;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 0;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 0;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 1;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable 0;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 0;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 0;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable 0;";

              pulse_on=1
              echo "#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;"
              if [[ "$line" = *"start_build"* ]] || [[ "$is_direct_cef" = 1 ]] || [[ "$is_direct_kodi" = 1 ]];then
                buildThreadForOS "${IOS_ATV2_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" $is_direct_cef $is_direct_kodi;
              elif [[ "$line" = *"start_addon_build"* ]];then
                buildThreadKodiAddonForOS "${IOS_ATV2_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" "$KODI_SEL_ADDON";
              elif [[ "$line" = *"kodi_force_build_step"* ]];then
                forceKodiSelectedBuild "${IOS_ATV2_BUILD_TYPE}" "${USE_LINUX_X86_DISTR}64" ${IOS_ATV2_BUILD_TYPE};fi
            }
            elif [[ "$line" = *"stop_build"* ]];then
            {
              if [ -f "$TEMP_DIR/build_thread-${IOS_ATV2_BUILD_TYPE}.pid" ];then
              {
                pid_to_kill=$(cat "$TEMP_DIR/build_thread-${IOS_ATV2_BUILD_TYPE}.pid");
                ps -p $pid_to_kill > /dev/null
                if [[ $? = 0 ]];then
                {
                  killtree $pid_to_kill KILL;
                  kill $pid_to_kill
                } fi
                rm -f "$TEMP_DIR/build_thread-${IOS_ATV2_BUILD_TYPE}.pid"
              } fi

              echo ""
              if [[ $pulse_on = 1 ]];then
              {
                echo "#> msg pulse off;";
                pulse_on=0;
              } fi
              echo "#> msg percent 0;";
              echo "#> msg field $BUILD__BTN_____BUILD_COMPLETE:visible 1;";
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:visible 1;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:visible 1;";
              echo "#> msg field $BUILD__BTN_________STOP_BUILD:visible 0;";
              if [ -f "$BASE_PATH/build/kodi-$GIT_USER/kodi-${IOS_ATV2_BUILD_TYPE}/kodi.bin" ];then
                kodi_direct=1
              else
                kodi_direct=0;fi
              echo "#> msg field $BUILD__BTN__BUILD_KODI_DIRECT:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN____BUILD_SEL_ADDON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___FORCE_BUILD_STEP:enable 1;";
              echo "#> msg field $BUILD__BTN_PERF_CODE_DEPCLEAN:enable 1;";
              echo "#> msg field $BUILD__CB______________ADD_ON:enable $kodi_direct;";
              echo "#> msg field $BUILD__BTN___BUILD_CEF_DIRECT:enable $([ -f "$BASE_PATH/build/cef-$GIT_CEF_USER/.cef-${IOS_ATV2_BUILD_TYPE}.active" ] && echo 1 || echo 0);";
            }
            elif [[ "$line" = *"depclean"* ]];then
            {
              showWarningDialog_YesNo "<b>All extra files on kodi not included in GIT becomes removed! \n\nAre you sure?</b>"
              if [ $? = 0 ];then
              {
                echo "NOT SUPPORTED!";







              } fi
            }
            elif [[ "$line" = *"openlogs"* ]];then
            {
              $TEXT_VIEVER \
                $BASE_PATH/build/creation-general.log \
                $BASE_PATH/build/creation-kodi-${IOS_ATV2_BUILD_TYPE}.log \
                $BASE_PATH/build/creation-cef-${IOS_ATV2_BUILD_TYPE}.log;
            }
            elif [[ "$line" = *"field $BUILD__BTN________LAUNCH_KODI:"* ]];then
            {
              enable=$(echo ${line} | awk -F'enable ' '{ print $2 }' | awk -F\; '{ print $1 }')
              echo "#> msg field $BUILD__BTN________LAUNCH_KODI:enable $enable;"
            }
            elif [[ "$line" = *"field $BUILD__CB______________ADD_ON:"* ]];then
            {
              KODI_SEL_ADDON=$(echo ${line} | awk -F\| '{ print $1 }' | awk -F\: '{ print $2 }')
              if [[ $KODI_SEL_ADDON != "(null)" ]];then
              {
                export KODI_SEL_ADDON
                saveConfigFile;
              } fi
            }
            elif [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n'; for p in ${line}; do
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "${IOS_ATV2_BUILD_TYPE}" $id "$value"
                else
                  id2=0
                  IFS=$'|';
                  for value2 in ${value}; do
                    parse_values "${IOS_ATV2_BUILD_TYPE}" $id2 "$value2"
                    ((id2++))
                  done;
                fi; IFS=$'\n';
              done; unset IFS;
              saveConfigFile;
              [ -z $SYSTEM_ACTIVE ] && exit 0;
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          }
          else
          {
            echo "$line"
          } fi
        } done

        if [ -f "$TEMP_DIR/build_thread-${IOS_ATV2_BUILD_TYPE}.pid" ];then
        {
          process_active=1
        }
        elif [[ $process_active != 0 ]];then
        {
          echo "#< msg stop_build;" >> "$thread8_in";
          process_active=0;
        } fi

        sleep 0.75;
      } done
    }
    done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="iOS/ATV2" \
             --pulsate \
             --xcom-log=$thread8_in \
             --field="Build complete:FBTN@0,1,0,2" "bash -c 'echo \"#< msg start_build\" > $thread8_in'" \
             --field="Build kodi direct:FBTN@2,3,0,2" "bash -c 'echo \"#< msg start_direct_build_kodi\" > $thread8_in'" \
             --field="Build CEF direct:FBTN@4,5,0,2" "bash -c 'echo \"#< msg start_direct_build_cef\" > $thread8_in'" \
             --field="Build selected addon:FBTN@8,8,0,2" "bash -c 'echo \"#< msg start_addon_build\" > $thread8_in'" \
             --field="Stop build:FBTN@0,8,2,4" "bash -c 'echo \"#< msg stop_build\" > $thread8_in'" \
             --field="Clear log:FBTN@0,0,4,6" "bash -c 'echo \"#> msg field $BUILD__TERMPROC_____BUILD_LOG:clear;\" >> $thread8_in'" \
             --field="Open last logs:FBTN@1,1,4,6" "bash -c 'echo \"#< msg openlogs\" > $thread8_in'" \
             --field="Launch Kodi:FBTN@2,3,4,6" "bash $BASE_PATH/tools/kodi.launch kodi-ios-atv2 $thread8_in" \
             --field="Force build step:FBTN@4,4,4,6" "bash -c 'echo \"#< msg kodi_force_build_step\" > $thread8_in'" \
             --field="Perform code depclean:FBTN@5,5,4,6" "bash -c 'echo \"#< msg depclean\" > $thread8_in'" \
             --field="Add-on:CB@7,8,4,6" '' \
             --field="Build log:termproc@0,9,8,10" "" > /dev/null 2>&1 &
  pid_thread8=$!

  TAB_LIST+="--tab=iOS/ATV2 "
  ((TAB_NUM++))
} fi
#
###############################################################################

###############################################################################
# Thread nine: Handle Settings

if [ -f $HOME/.mupel/android.conf ];then
  . $HOME/.mupel/android.conf;fi
if [ -f $HOME/.mupel/windows.conf ];then
. $HOME/.mupel/windows.conf;fi
if [ -f $HOME/.mupel/mac-osx.conf ];then
. $HOME/.mupel/mac-osx.conf;fi

{
  (
    while :;do
    {
      if [ -f ./build/global_mupel_install ];then
      {
        [ -z $SYSTEM_ACTIVE ] && exit 0;
        sleep 2;
        continue;
      } fi

      loadConfigFile

      [ $KODI_SOURCE_USE_BASE != "TRUE" ] && use_it=1 || use_it=0
      echo "#> msg field $SET_KODI________SOURCE_REPOSI:enable $use_it;"

      [ $CEF_SOURCE_USE_BASE != "TRUE" ] && use_it=1 || use_it=0
      echo "#> msg field $SET_CEF_________SOURCE_REPOSI:enable $use_it;"
      [[ $SUPPORT_CEF = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_CEF_________SOURCE_BRANCH:visible $use_it;"
      echo "#> msg field $SET_CEF_________VERBOSE_BUILD:visible $use_it;"

      [[ $USE_LINUX_X86_32 = "TRUE" ]] && [[ $USE_LINUX_X86_64 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_LINUX__________BUILD_TYPE:enable $use_it;"

      [[ $USE_MS_WINDOWS_32 = "TRUE" ]] || [[ $USE_MS_WINDOWS_64 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_WINDOWS____________TARGET:visible $use_it;"
      echo "#> msg field $SET_WINDOWS______SSH_USERNAME:visible $use_it;"
      echo "#> msg field $SET_WINDOWS______SSH_PASSWORD:visible $use_it;"
      [[ $USE_MS_WINDOWS_32 = "TRUE" ]] && [[ $USE_MS_WINDOWS_64 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_WINDOWS________BUILD_TYPE:enable $use_it;"
      targets="x86_32!x86_64"
      targets=$(echo ${targets//$WINDOWS_BUILD_TYPE/\^${WINDOWS_BUILD_TYPE}});
      echo "#> msg field $SET_WINDOWS________BUILD_TYPE:set $targets;"

      [[ $USE_MAC_OS_X_32 = "TRUE" ]] || [[ $USE_MAC_OS_X_64 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_MAC________________TARGET:visible $use_it;"
      echo "#> msg field $SET_MAC__________SSH_USERNAME:visible $use_it;"
      echo "#> msg field $SET_MAC__________SSH_PASSWORD:visible $use_it;"
      echo "#> msg field $SET_MAC________________SSH_IP:visible $use_it;"
      echo "#> msg field $SET_MAC______________SSH_PORT:visible $use_it;"
      [[ $USE_MAC_OS_X_32 = "TRUE" ]] && [[ $USE_MAC_OS_X_64 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_MAC____________BUILD_TYPE:enable $use_it;"
      targets="x86_32!x86_64"
      targets=$(echo ${targets//$MAC_OS_X_BUILD_TYPE/\^${MAC_OS_X_BUILD_TYPE}});
      echo "#> msg field $SET_MAC____________BUILD_TYPE:set $targets;"
      selected=$(echo $IOS_ATV2_BUILD_TYPE | tr '[:lower:]' '[:upper:]');
      targets="IOS!ATV2";
      targets=$(echo ${targets//$selected/\^${selected}});
      echo "#> msg field $SET_MAC____IOS_ATV_BUILD_TYPE:set $targets;";

      [[ $USE_ANDROID_ARM = "TRUE" ]] || [[ $USE_ANDROID_X86 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_ANDROID________BUILD_TYPE:visible $use_it;"
      echo "#> msg field $SET_ANDROID__BUILD_SYS_TARGET:visible $use_it;"
      echo "#> msg field $SET_ANDROID_______AVD_MANAGER:visible $use_it;"
      [[ $USE_ANDROID_ARM = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:visible $use_it;"
      [[ $USE_ANDROID_X86 = "TRUE" ]] && use_it=1 || use_it=0
      echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:visible $use_it;"

      parse_values "settings" 1 "$KODI_SOURCE_URL";
      parse_values "settings" 8 "$CEF_SOURCE_URL";
      echo "#> msg field $SET_CEF_________VERBOSE_BUILD:set $CEF_VERBOSE_BUILD;";
      echo "#> msg field $SET_VARIOUS_____CPU_PROC_JOBS:set $CPU_PROC_JOBS;"

      # Main loop
      while :;do
      {
        if [ ! -f "$thread9_in" ];then
          exit 0;fi

        if [ -f ./build/global_mupel_install ];then
        {
          [ -z $SYSTEM_ACTIVE ] && exit 0;
          break;
        } fi

        proc=$(cat "$thread9_in")
        echo -n "" > "$thread9_in";
        IFS=$'\n';
        for line in ${proc}; do
        {
          if [[ "$line" == "#< msg"* ]];then
          {
            if [[ "$line" = *"field"* ]];then
            {
              IFS=$'\n';
              for p in ${line}; do
              {
                id=$(echo ${p} | awk -F ' ' '{print $4}' | awk -F ':' '{print $1}')
                value=$(echo ${p#*:} | awk -F ';' '{print $1}')
                IFS=$'|';
                if [[ "$id" -ge "0" ]];then
                  parse_values "settings" $id "$value"
                else
                  id2=0
                  IFS=$'|'; for value2 in ${value}; do
                    parse_values "settings" $id2 "$value2"
                    ((id2++))
                  done;
                  [ -z $SYSTEM_ACTIVE ] && exit 0;
                fi; IFS=$'\n';
              } done; unset IFS;
            }
            elif [[ "$line" = *"android_emu_keys"* ]];then
            {
              showAndroidEmulatorKeyHelp &
            }
            elif [[ "$line" = *"git_command_help"* ]];then
            {
              showGitCommandHelp &
            }
            elif [[ "$line" = *"ssh_access_windows"* ]];then
            {
              ssh_access_windows &
            }
            elif [[ "$line" = *"ssh_access_mac_os_x"* ]];then
            {
              ssh_access_mac_os_x &
            }
            elif [[ "$line" = *"jenkins"* ]];then
            {
              showdialog --title="Mupel - Jenkins place" \
                         --width=520 --height=474 --html \
                         --uri=$BASE_PATH/icons/jenkins-holiday.png \
                         --text="<i><span size=\"large\">Hi, I'm still in holiday</span></i>" \
                         --button=gtk-ok:0 &
            }
            elif [[ "$line" = *"open_avd_control"* ]];then
            {
              . $HOME/.mupel/android.conf;
              $ANDROID_DEV_ROOT/android-sdk-linux/tools/android avd

              echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:set $(getAndroidAVDS arm);"
              echo "#> msg field $SET_ANDROID____ARM_EMU_SOURCE:set $(getAndroidAVDS x86);"
            }
            elif [[ "$line" = *"open_dist_control"* ]];then
            {
              $BASE_PATH/tools/linux/install-systembuild-linux &
            }
            else
              echo "Wrong command! $line" > /dev/stderr;fi
          } fi
        } done;
        unset IFS

        sleep 0.5
      } done
    } done
  ) | \
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Settings" \
             --pulsate \
             --xcom-log=$thread9_in \
             --field=":LBL@0,8,0,2" '' \
             --field="<b>Kodi:</b>:LBL@0,8,2,4" '' \
             --field="Repository:@0,4,4,6" "$KODI_SOURCE_URL" \
             --field="Use base:CHK@5,6,4,6" "$KODI_SOURCE_USE_BASE" \
             --field="Branch:CB@7,8,4,6" '' \
             --field="Run tests:CHK@0,0,6,8" "$KODI_RUN_TESTS" \
             --field="Include configure in direct build:CHK@1,1,6,8" "$KODI_CONF_IN_DIRECT_BUILD" \
             --field="Perform depclean on branch change:CHK@2,2,6,8" "$KODI_DEP_CLEAN" \
             --field=":LBL@0,8,10,11" '' \
             --field="<b>CEF (Chromium embedded framwork):</b>:LBL@0,8,11,12" '' \
             --field="Repository:@0,4,12,13" "$CEF_SOURCE_URL" \
             --field="Use base:CHK@5,6,12,13" "$CEF_SOURCE_USE_BASE" \
             --field="Branch:CB@7,8,12,13" '' \
             --field="Verbose build:CHK@0,1,13,14" "$CEF_VERBOSE_BUILD" \
             --field=":LBL@0,8,15,16" '' \
             --field="<b>Linux settings:</b>:LBL@0,8,16,17" '' \
             --field="Build type:CB@6,7,16,17" 'x86_32!x86_64' \
             --field="Used 32/64bit Distribution:CB@0,1,17,18" "$(getLinuxTargetDist)" \
             --field="Open distribution control:FBTN@7,8,17,18" "bash -c 'echo \"#< msg open_dist_control\" >> $thread9_in'" \
             --field=":LBL@0,8,21,22" '' \
             --field="<b>Windows settings:</b>:LBL@0,8,22,23" '' \
             --field="Build type:CB@6,8,22,23" 'x86_32!x86_64' \
             --field="Build system target:CB@0,5,23,24" "$(getWindowsTargets)" \
             --field="Username / Password (ssh):@6,7,23,24" "$WINDOWS_SSH_USERNAME" \
             --field=":H@7,8,23,24" "$WINDOWS_SSH_PASSWORD" \
             --field=":LBL@0,8,28,29" '' \
             --field="<b>Mac OS X settings:</b>:LBL@0,8,29,30" '' \
             --field="Build type:CB@6,7,29,30" 'x86_32!x86_64' \
             --field=":CB@7,8,29,30" 'IOS!ATV2' \
             --field="Build system target:CB@0,5,30,31" "$(getMacOSXTargets)" \
             --field="Username / Password (ssh):@6,7,30,31" "$MAC_OS_X_SSH_USERNAME" \
             --field=":H@7,8,30,31" "$MAC_OS_X_SSH_PASSWORD" \
             --field="URL or IP / Port (ssh):@6,7,31,32" "$MAC_OS_X_SSH_IP" \
             --field=":@7,8,31,32" "$MAC_OS_X_SSH_PORT" \
             --field=":LBL@0,8,37,38" '' \
             --field="<b>Android settings:</b>:LBL@0,8,38,39" '' \
             --field="Android Virtual Device (AVD) Manager:FBTN@7,8,38,39" "bash -c 'echo \"#< msg open_avd_control\" >> $thread9_in'" \
             --field="ARM AVD emulation system:CB@0,3,39,40" "$(getAndroidAVDS arm)" \
             --field="Build type:CB@7,8,39,40" 'arm!x86' \
             --field="x86 AVD emulation system:CB@0,3,40,41" "$(getAndroidAVDS x86)" \
             --field="Build system target:CB@7,8,40,41" "$(getAndroidTargets)" \
             --field=":LBL@0,8,41,42" '' \
             --field="CPU process jobs:NUM@0,8,43,44" "${CPU_PROC_JOBS}!1..32" \
             --field=":XTALK" '' > /dev/null &
  pid_thread9=$!
  ((TAB_NUM++))
}
#
###############################################################################

###############################################################################
# Thread ten: Handle help
{
  yad-mupel-x86_64 --plug=$KEY --tabnum=$TAB_NUM --form \
             --text="Help" \
             --field=":LBL@0,1,0,1" '' \
             --field="<b>Helper commands:</b>:LBL@0,1,1,2" '' \
             --field="Open ssh access console to Windows:FBTN@0,0,2,3" "bash -c 'echo \"#< msg ssh_access_windows\" >> $thread9_in'" \
             --field="Open ssh access console to Mac OS X:FBTN@1,1,2,3" "bash -c 'echo \"#< msg ssh_access_mac_os_x\" >> $thread9_in'" \
             --field=":LBL@0,1,3,4" '' \
             --field="<b>Help documentation:</b>:LBL@0,1,4,5" '' \
             --field="Git command help:FBTN@0,0,5,6" "bash -c 'echo \"#< msg git_command_help\" >> $thread9_in'" \
             --field="Android emulator keys:FBTN@1,1,5,6" "bash -c 'echo \"#< msg android_emu_keys\" >> $thread9_in'" \
             --field=":LBL@0,1,6,7" '' \
             --field="What does jenkins?:FBTN@0,1,7,8" "bash -c 'echo \"#< msg hello_jenkins\" >> $thread9_in'" \
             --field="About:FBTN@0,1,8,9" "bash ./mupel --info" > /dev/null &
  ((TAB_NUM++))
}
#
###############################################################################

###############################################################################
# Thread main
{
yad-mupel-x86_64 --notebook \
      --width=1024 --height=768 \
      --title="Mupel" \
      --window-icon="$BASE_PATH/icons/icon-mupel-128x128.png" \
      --image="$BASE_PATH/icons/icon-kodi-mbe.png" \
      --image-on-top \
      --text="\
<i><span size=\"larger\">Multi platform build environment for Kodi on Linux (Mupel)</span></i>
<i>Version:</i> $MUPEL_VERSION" \
      --key=$KEY \
      --tab-pos=left \
      --tab="General" \
      $TAB_LIST \
      --tab="Settings" \
      --tab="Help" \
      --button=gtk-ok:0 > /dev/null 2>&1

unset SYSTEM_ACTIVE
}
#
###############################################################################

cleanup > /dev/null

exit
